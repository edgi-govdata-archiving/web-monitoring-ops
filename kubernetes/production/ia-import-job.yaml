apiVersion: batch/v1
kind: CronJob
metadata:
  name: ia-import-job
  namespace: production
spec:
  # FIXME: schedule *should* be "30 3 * * *". Current schedule is a test.
  # schedule: "30 3 * * *"
  schedule: "20 18 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          # Kill after 12 hours. Sometimes it gets stuck!
          activeDeadlineSeconds: 43200
          containers:
          - name: ia-import-job
            image: envirodgi/processing:latest
            command: [
              "scripts/wm",
              "import",
              "ia-known-pages",
              "--parallel", "10",
              "--unplaybackable", "s3://edgi-wm-db-internal/importer-unplaybackable-cache.json",
              "--precheck",
              # The last 7 days
              "--from", "168"
            ]
            imagePullPolicy: Always
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "1024Mi"
                cpu: "1500m"
            env:
            - name: WEB_MONITORING_DB_EMAIL
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: import_db_email
            - name: WEB_MONITORING_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: import_db_password
            - name: WAYBACK_RATE_LIMIT
              value: "10"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: aws_access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: aws_secret_access_key

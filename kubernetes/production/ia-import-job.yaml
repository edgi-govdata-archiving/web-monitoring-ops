apiVersion: batch/v1
kind: CronJob
metadata:
  name: ia-import-job
  namespace: production
spec:
  schedule: "30 3 * * *"
  concurrencyPolicy: Replace
  startingDeadlineSeconds: 600  # 10 minutes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      # Ensuring the pod only runs once is a little complex. backoffLimit
      # determines how many times the job's pods will be recreated if the fail.
      # (Important: deleting a pod is disruption, not a failure, and does not
      # count toward the backoff limit. If you want to cancel the job, delete
      # the *job*, not the pod.)
      # activeDeadlineSeconds is defined on the job, not the pod. If
      # applied to the pod, the job could keep recreating pods forever if
      # backoffLimit or something else doesn't stop it.
      # (Newer versions of Kube let you fine-tune things a bit with
      # podFailurePolicy, but that's not availabe yet.)
      backoffLimit: 0
      # The job occasionally gets stuck!
      activeDeadlineSeconds: 28800  # 8 hours
      template:
        spec:
          restartPolicy: Never
          # Graceful shutdown can take a while here.
          terminationGracePeriodSeconds: 600
          containers:
          - name: ia-import-job
            image: envirodgi/processing:latest
            command: [
              "scripts/wm",
              "import",
              "ia-known-pages",
              "--parallel", "10",
              "--unplaybackable", "s3://edgi-wm-db-internal/importer-unplaybackable-cache.json",
              "--precheck",
              # The last 7 days
              "--from", "168"
            ]
            imagePullPolicy: Always
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "1024Mi"
                cpu: "1500m"
            env:
            - name: WEB_MONITORING_DB_EMAIL
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: import_db_email
            - name: WEB_MONITORING_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: import_db_password
            - name: WAYBACK_RATE_LIMIT
              value: "10"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: aws_access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: job-secrets
                  key: aws_secret_access_key
